services:
    postgres:
        image: postgres:16
        container_name: keycloak-postgres
        restart: unless-stopped
        environment:
            POSTGRES_DB: keycloak
            POSTGRES_USER: keycloak
            POSTGRES_PASSWORD: keycloak
        volumes:
            - postgres_data:/var/lib/postgresql/data

    keycloak:
        build:
            context: .
            dockerfile: Dockerfile
        container_name: keycloak-gotrust
        restart: unless-stopped
        depends_on:
            - postgres
        ports:
            - "8080:8080"

        environment:
            # ----- Database -----
            KC_DB: postgres
            KC_DB_URL: jdbc:postgresql://postgres:5432/keycloak
            KC_DB_USERNAME: keycloak
            KC_DB_PASSWORD: keycloak

            # ----- Admin (master realm) -----
            KEYCLOAK_ADMIN: admin
            KEYCLOAK_ADMIN_PASSWORD: admin

            # ----- Hostname / HTTP (relaxed for local) -----
            KC_HOSTNAME: localhost
            KC_HOSTNAME_STRICT: "false"
            KC_HOSTNAME_STRICT_HTTPS: "false"
            KC_HTTP_ENABLED: "true"

        command:
            - start
            - --optimized
            - --import-realm

        # Mount your realm export from the project root.
        # Put your exported JSON as realm-config.json there.
        volumes:
            - ./realm-export.json:/opt/keycloak/data/import/realm-export.json

volumes:
    postgres_data:
